# Sequential Number Generation Implementation

## Date: December 15, 2025

## Overview
Implemented sequential number generation for:
- **Invoice Numbers** - Start from 100001, increment sequentially
- **Credit Note Numbers** - Start from CN100001, increment sequentially  
- **Quotation Numbers** - Start from 100001, increment sequentially
- **Expense Credit Notes** - Start from ECN100001, increment sequentially
- **Purchase Credit Notes** - Start from PCN100001, increment sequentially

## How It Works

Each number is generated by:
1. Querying the backend (Firestore) for the highest existing number
2. Extracting the numeric part
3. Incrementing by 1
4. Returning the new number

If no previous records exist, numbers start from **100001**.

## New Service Created

### `lib/services/number_generator_service.dart`

```dart
class NumberGeneratorService {
  static const int _startNumber = 100001;

  // Generate next invoice number
  static Future<String> generateInvoiceNumber() async { ... }

  // Generate next credit note number (CN100001, CN100002, ...)
  static Future<String> generateCreditNoteNumber() async { ... }

  // Generate next quotation number
  static Future<String> generateQuotationNumber() async { ... }

  // Generate next expense credit note (ECN100001, ECN100002, ...)
  static Future<String> generateExpenseCreditNoteNumber() async { ... }

  // Generate next purchase credit note (PCN100001, PCN100002, ...)
  static Future<String> generatePurchaseCreditNoteNumber() async { ... }
}
```

## Files Modified

### 1. `lib/Sales/Bill.dart`
- Added import for `NumberGeneratorService`
- **SplitPaymentPage**: Changed from `(100000 + Random().nextInt(900000))` to `NumberGeneratorService.generateInvoiceNumber()`
- **PaymentPage**: Changed from `(100000 + Random().nextInt(900000))` to `NumberGeneratorService.generateInvoiceNumber()`

### 2. `lib/Sales/Quotation.dart`
- Added import for `NumberGeneratorService`
- Changed from `(100000 + random.nextInt(900000))` to `NumberGeneratorService.generateQuotationNumber()`

### 3. `lib/Menu/Menu.dart`
- Added import for `NumberGeneratorService`
- **Cancel Bill Credit Note**: Changed from `'CN${DateTime.now().millisecondsSinceEpoch}'` to `NumberGeneratorService.generateCreditNoteNumber()`

### 4. `lib/Stocks/Expenses.dart`
- Added import for `NumberGeneratorService`
- **Expense Credit Note**: Changed from `'ECN${DateTime.now().millisecondsSinceEpoch}'` to `NumberGeneratorService.generateExpenseCreditNoteNumber()`

### 5. `lib/Stocks/StockPurchase.dart`
- Added import for `NumberGeneratorService`
- **Purchase Credit Note**: Changed from `'PCN${DateTime.now().millisecondsSinceEpoch}'` to `NumberGeneratorService.generatePurchaseCreditNoteNumber()`

## Number Format Examples

| Type | Old Format | New Format |
|------|-----------|------------|
| Invoice | 123456 (random) | 100001, 100002, 100003... |
| Credit Note | CN1734567890123 (timestamp) | CN100001, CN100002... |
| Quotation | 987654 (random) | 100001, 100002, 100003... |
| Expense Credit | ECN1734567890123 (timestamp) | ECN100001, ECN100002... |
| Purchase Credit | PCN1734567890123 (timestamp) | PCN100001, PCN100002... |

## Benefits

1. **Professional Look** - Clean, sequential numbers look more professional
2. **Easy Tracking** - Numbers are easy to reference and track
3. **No Duplicates** - Backend query ensures no duplicate numbers
4. **Audit Trail** - Sequential numbers help in auditing
5. **Customer Friendly** - Easier for customers to reference invoices

## Technical Notes

### Query Method
Each number type queries its respective collection:
- `sales` collection for invoice numbers
- `creditNotes` collection for credit notes
- `quotations` collection for quotation numbers
- `purchaseCreditNotes` collection for expense/purchase credit notes

### Error Handling
If the query fails (e.g., offline), the service falls back to starting number (100001).

### Store-Scoped
All queries use `FirestoreService().getStoreCollection()` to ensure numbers are scoped per store.

## Testing

1. **First Invoice**: Should be 100001
2. **Subsequent Invoices**: Should increment (100002, 100003, etc.)
3. **After App Restart**: Should continue from last number
4. **Multiple Stores**: Each store has independent numbering

## Future Enhancements

1. **Prefix Customization** - Allow stores to customize prefixes (e.g., "INV-100001")
2. **Year Reset** - Option to reset numbers at start of new financial year
3. **Format Settings** - Allow custom formats like "2024/100001"
4. **Offline Queue** - Pre-fetch next numbers for offline use

